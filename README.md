# fabric-sync-filesystem

Файйлы и папки:

 * sample-server - пример настройки виртуального дерева
 * sample-server/filesystem - пример виртуального дерева
 * sample-server/filesystem.settings - настройки виртуального дерева
 * server.py - Настройки fabric для соединения к нужному серверу (по альясам). Там же указываются директория для синка


### Синтаксис filesystem.settings

```init
# Поддерживаются комментарии


# Группирование как ".ini". В данном случае имя группы используется как имя пользователя на удаленном сервере
# Этот пользователь будет использован для всех путей в этой группе (он будет указан владельцем для файлов которые попадут под указанные пути)
# Следует обязательно иметь (пока) такую запись в начале
[root] 
# Захватывает все пути
/

# Можно указать mode который будет применять к файлам после синхронизации
# Указать можно как для группы, так и для конкретного файла
# Под указанные пути попадут все пути начинающиеся с указанных (масло масленым)
[other-user, mode=0777]
/home/other-user 
/home/other-user/.ssh/authorized_keys mode=0600

});
```

### Нюансы

В директории сервера (например sample-server) должен быть инициализирован mercurial репозиторий.
```
#Самое простое
hg init
```

Есть два режима работы скрипта:
* Полная синхронизация
* Синхронизация обновлений - синхронизирует только модифицированные файлы(в том числе и удаленные). После того, как синхронизирует - выполняет автоматический коммит.

В любом случае перед тем как залить файлы, скрипт выведет список файлов которые собирается залить и уточнит, все ли в порядке.

#### Внимание: Скрипт учитывает только те файлы, которые имеют состояние tracking в hg. Т.е. если добавлен новый файл, его надо вручную добавить через команду 
```
hg add [folder|file]

# Выведет список всех файлов с их статусом (например ? - за такими hg не следит, и они не учитываются скриптом. Их нужно в ручную добавить)
hg status --all
```


### Использование

#### Синк всего дерева
```bash
fab sync:[server-alias]
```

#### Синк изменений
```bash
fab sync_changes:[server-alias]
```

Скрипт автоматически вызовет функцию из файла servers.py с именем:
```
def env_[server_alias]():
```
В ней соответственно нужно указать все конфиги для фабрика, чтобы он знал куда подключаться.
Также там же указывается АБСОЛЮТНЫЙ путь к локальной директории в которой находится виртуальное дерево.
Например до папки /absolute/path/sample-server/filesystem

